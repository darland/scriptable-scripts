{
  "always_run_in_app" : false,
  "icon" : {
    "color" : "brown",
    "glyph" : "magic"
  },
  "name" : "OZON BARCODE",
  "script" : "\/\/ Variables used by Scriptable.\n\/\/ These must be at the very top of the file. Do not edit.\n\/\/ icon-color: deep-gray; icon-glyph: magic;\n\n\/\/ This script was created by Artem Tiumentcev\n\nconst debug = false;\nconst baseURL = 'https:\/\/api.ozon.ru\/';\n\nlet deviceID = Keychain.contains('ozonWidget_deviceID') ? Keychain.get('ozonWidget_deviceID') : generateDeviceID();\n\nlet defaultHeaders = {\n    'Content-Type': 'application\/json; charset=utf-8',\n    'Accept': 'application\/json; charset=UTF-8',\n    'Accept-Encoding': 'gzip, deflate, br',\n    'Connection': 'Keep-Alive',\n    'Cache-Control': 'no-cache',\n    'User-Agent': 'OzonStore\/825',\n    'x-o3-sdk-versions': 'ozonid_ios\/6.0.1',\n    'x-o3-language': 'ru',\n    'x-o3-app-name': 'ozonapp_ios',\n    'x-o3-app-version': '17.17.0(825)',\n};\n\nlet deviceInfo = {\n    \"vendor\": \"Apple\",\n    \"supportCountrySelect\": true,\n    \"deviceId\": deviceID,\n    \"os\": \"iOS\",\n    \"hasBiometrics\": true,\n    \"biometryType\": \"faceId\",\n    \"model\": \"iPhone15,4\",\n    \"version\": Device.systemVersion(),\n}\n\nfunction generateDeviceID() {\n    let id = '';\n    let parts = [8, 4, 4, 4, 12];\n\n    for (let i = 0; i < parts.length; i++) {\n        let part = '';\n        for (let j = 0; j < parts[i]; j++) {\n            part += Math.floor(Math.random() * 16).toString(16);\n        }\n        id += part;\n        if (i < parts.length - 1) {\n            id += '-';\n        }\n    }\n\n    return id.toLocaleUpperCase();\n}\n\nasync function request(path, method, headers, data) {\n    if (debug) {\n        console.log('Request: ' + JSON.stringify({\n            path: path,\n            method: method,\n            headers: headers,\n            data: data\n        }));\n    }\n\n    const req = new Request(baseURL + path);\n\n    req.method = method || 'GET';\n    req.headers = {...defaultHeaders, ...headers};\n\n    if (data) {\n        req.body = JSON.stringify(data)\n    }\n\n    const json = await req.loadJSON()\n    if (json.error) {\n        if (debug) {\n            console.error(json.error);\n        }\n\n        return Promise.reject(json.error)\n    }\n\n    if (debug) {\n        console.log('Response: ' + JSON.stringify(json));\n    }\n\n    return json\n}\n\nasync function initPromptOTP(title) {\n    const promptOTP = new Alert();\n\n    promptOTP.title = 'Ozon';\n    promptOTP.message = title || 'Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ¾Ð´ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ';\n    promptOTP.addTextField('ÐšÐ¾Ð´ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ', '', '');\n    promptOTP.addAction('ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ');\n    promptOTP.addCancelAction('ÐžÑ‚Ð¼ÐµÐ½Ð°');\n\n    let answerOTP = await promptOTP.presentAlert();\n\n    return [promptOTP.textFieldValue(0), answerOTP];\n}\n\nasync function setupAssistant() {\n    let promptInfo = new Alert()\n    promptInfo.message = 'Ð”Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð²Ð¸Ð´Ð¶ÐµÑ‚Ð° Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð²Ð¾Ð¹Ñ‚Ð¸ Ð² Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ ÐºÐ°Ð±Ð¸Ð½ÐµÑ‚ Ozon. ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ðº Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐµ?'\n    promptInfo.addAction('Ð”Ð°')\n    promptInfo.addCancelAction('ÐÐµÑ‚')\n\n    if (await promptInfo.presentAlert() === -1) {\n        throw new Error('ÐžÑ‚Ð¼ÐµÐ½ÐµÐ½Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼');\n    }\n\n    const promptLoginType = new Alert();\n\n    promptLoginType.title = 'Ð’Ñ…Ð¾Ð´ Ð² Ozon';\n    promptLoginType.message = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ‚Ð¸Ð¿ Ð²Ñ…Ð¾Ð´Ð°:';\n    promptLoginType.addAction('E-mail');\n    promptLoginType.addAction('Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½');\n\n    let loginType = await promptLoginType.presentAlert();\n\n    \/\/ default login path for phone\n    let loginPath = 'composer-api.bx\/_action\/ozonIdPageEntry?widgetName=csma.entryCredentialsRequired';\n\n    if (loginType === 0) {\n        console.log('Ð’Ñ…Ð¾Ð´Ð¸Ð¼ Ð¿Ð¾ E-mail...');\n        loginPath = 'composer-api.bx\/_action\/ozonIdPageEntry?iso=RU&type=emailOtpEntry&widgetName=csma.entryCredentialsRequired';\n    }\n\n    \/\/ make a first request to get the submit button\n    let json = await request(loginPath, 'POST', {}, deviceInfo);\n\n    let submit = json.data.submitButton;\n    if (!submit) {\n        throw new Error('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð½Ð°Ð¹Ñ‚Ð¸ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð²Ñ…Ð¾Ð´Ð°. Ð¡Ð°Ð¹Ñ‚ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½?');\n    }\n\n    const promptLogin = new Alert();\n    promptLogin.title = 'Ð’Ñ…Ð¾Ð´ Ð² Ozon';\n\n    if (loginType === 0) {\n        promptLogin.message = 'Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð²Ð°Ñˆ E-mail';\n        promptLogin.addTextField('E-mail', '', '');\n    } else {\n        promptLogin.message = 'Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð²Ð°Ñˆ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½';\n        promptLogin.addTextField('Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½ 7xxxxxxxxxx', '', '');\n    }\n\n    promptLogin.addAction('Ð’Ð¾Ð¹Ñ‚Ð¸');\n    promptLogin.addCancelAction('ÐžÑ‚Ð¼ÐµÐ½Ð°');\n\n    if (await promptLogin.presentAlert() === -1) {\n        throw new Error('ÐžÑ‚Ð¼ÐµÐ½ÐµÐ½Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼');\n    }\n\n    let login = promptLogin.textFieldValue(0);\n\n    let reqData = {\n        \"deviceId\": deviceID,\n        \"model\": \"iPhone15,4\",\n        \/\/ \"connectionType\": \"CELLULAR_4G\",\n    }\n\n    if (loginType === 0) {\n        reqData.email = login;\n    } else {\n        reqData.phone = login;\n    }\n\n    json = await request('composer-api.bx\/_action\/' + submit.action, 'POST', {}, reqData);\n\n    while (json.status && json.status.deeplink) {\n        if (debug) {\n            console.log('ÐŸÐ¾Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð»Ð°ÑÑŒ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°: ' + json.status.deeplink);\n        }\n\n        json = await request('composer-api.bx\/_action\/' + json.status.deeplink.replace(\/^ozon:\\\/\\\/\/, ''), 'POST');\n\n        let otp = json.data;\n\n        if (!otp.subtitle) {\n            throw new Error(otp.title);\n        }\n\n        let [otpCode, answerOTP] = await initPromptOTP(otp.title);\n\n        if (answerOTP === -1) {\n            throw new Error('ÐžÑ‚Ð¼ÐµÐ½ÐµÐ½Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼');\n        }\n\n        json = await request('composer-api.bx\/_action\/' + otp.action, 'POST', {}, {\n            ...deviceInfo,\n            ...otp.data,\n            otp: otpCode\n        });\n\n        if (json.status && json.status.deeplink && (\/isLongTimeNoSee=true\/i.test(json.status.deeplink))) {\n            \/\/ long time no see and need to check by email\n            json = await request('composer-api.bx\/_action\/' + json.status.deeplink.replace(\/^ozon:\\\/\\\/\/, ''));\n            json = await request('composer-api.bx\/_action\/' + json.data.submitButton.action);\n            json = await request('composer-api.bx\/_action\/' + json.status.deeplink.replace(\/^ozon:\\\/\\\/\/, ''));\n\n            otp = json.data;\n\n            let [otpCode, answerOTP] = await initPromptOTP();\n            if (answerOTP === -1) {\n                throw new Error('ÐžÑ‚Ð¼ÐµÐ½ÐµÐ½Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼');\n            }\n\n            json = await request('composer-api.bx\/_action\/' + otp.action, 'POST', {}, {\n                ...deviceInfo,\n                ...otp.data,\n                extraOtp: otpCode\n            });\n        }\n\n        if (json.data && json.data.authToken) {\n            saveAuthToken(json.data.authToken);\n        }\n    }\n\n    console.log('Logged in successfully');\n}\n\nfunction saveAuthToken(authToken) {\n    Keychain.set('ozonWidget_authToken', JSON.stringify(authToken));\n}\n\nasync function refreshAuthToken(authToken) {\n    let json = await request('composer-api.bx\/_action\/initAuthRefresh', 'POST', {}, {\n        \"refreshToken\": authToken.refreshToken\n    });\n\n    if (!json.authToken) {\n        throw new Error('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ñ‚Ð¾ÐºÐµÐ½');\n    }\n\n    saveAuthToken(json.authToken);\n\n    return {\n        'Authorization': json.authToken.tokenType + ' ' + json.authToken.accessToken\n    }\n}\n\nasync function getAuthHeader() {\n    let authToken = JSON.parse(Keychain.get('ozonWidget_authToken'));\n\n    let authHeader = {\n        'Authorization': authToken.tokenType + ' ' + authToken.accessToken\n    }\n\n    \/\/ check token validity\n    try {\n        await request('composer-api.bx\/_action\/getUserV2', 'POST', authHeader, {\"profile\": true});\n    } catch (e) {\n        if (debug) {\n            console.error(e);\n        }\n\n        authHeader = await refreshAuthToken(authToken);\n    }\n\n    return authHeader;\n}\n\nasync function createWidget(authHeader) {\n    let widget = new ListWidget();\n    widget.backgroundColor = new Color(\"#FFFFFF\");\n\n    let jsonData = await request('composer-api.bx\/page\/json\/v2?url=\/my\/orderlist\/barcode\/', 'GET', authHeader);\n    let barcodeStateId = Object.keys(jsonData.widgetStates).find(key => key.startsWith('barcode'));\n\n    if (barcodeStateId) {\n        let barcodeData = JSON.parse(jsonData.widgetStates[barcodeStateId]);\n\n        if (barcodeData && barcodeData.shipments && barcodeData.shipments[0] && barcodeData.shipments[0].code) {\n            let code = barcodeData.shipments[0].code;\n            let reqBarcodeImage = await new Request('https:\/\/api.ozon.ru\/my-account-api-gateway.bx\/codes\/v1\/generate?code=' + code + '&height=198&type=bar&width=670');\n            let barcodeImage = await reqBarcodeImage.loadImage();\n            let barcodeImageElement = widget.addImage(barcodeImage);\n            barcodeImageElement.centerAlignImage();\n        }\n\n        \/\/ hint\n        if (barcodeData && barcodeData.shipments && barcodeData.shipments[0] && barcodeData.shipments[0].hint) {\n            widget.addSpacer(5);\n            let hint = widget.addText(barcodeData.shipments[0].hint);\n            hint.font = Font.boldSystemFont(25);\n            hint.centerAlignText()\n            hint.textColor = new Color(\"#000000\");\n        }\n    } else {\n        \/\/ show emoji if poop\n        let emoji = widget.addText('ðŸ“¦âœˆï¸ðŸššðŸ“¬');\n        emoji.font = Font.boldSystemFont(50);\n        emoji.centerAlignText()\n        emoji.textColor = new Color(\"#000000\");\n    }\n\n    \/\/ Return the created widget\n    return widget;\n}\n\nasync function setupWidget() {\n    if (!Keychain.contains('ozonWidget_authToken')) {\n        try {\n            await setupAssistant();\n        } catch (e) {\n            if (debug) {\n                console.error(e);\n            }\n\n            return;\n        }\n    }\n\n    let authHeader = await getAuthHeader();\n    let widget = await createWidget(authHeader);\n\n    \/\/ Check where the script is running\n    if (config.runsInWidget) {\n        \/\/ Runs inside a widget so add it to the homescreen widget\n        \/\/ Refresh the widget after 8 hours\n        widget.refreshAfterDate = new Date(Date.now() + 8 * 60 * 60 * 1000);\n\n        Script.setWidget(widget);\n    } else if (config.runsInApp && args.widgetParameter && Object.keys(args.widgetParameter).length > 0) {\n        \/\/ Open Ozon app and show the expanded barcode\n        Safari.open('ozon:\/\/my\/barcodeExpanded\/');\n    } else {\n        \/\/ Show the medium widget inside the app\n        widget.presentMedium();\n    }\n\n    Script.complete();\n}\n\nawait setupWidget();\n",
  "share_sheet_inputs" : [

  ]
}